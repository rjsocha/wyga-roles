---
- name: "Process allow/any ..."
  block:
    - name: "Append rule ..."
      set_fact:
        fwrules: "{{ fwrules + [ { 'any': 'any' } ] }}"
        rule_parsed: true
  when: rule.allow == 'any'

- name: "Process allow/http ..."
  block:
    - name: "Append http/https/http3 rules ..."
      set_fact:
        fwrule_http:
          - { 'dport': '80', 'match': 'tcp', 'proto': 'tcp' }
          - { 'dport': '443', 'match': 'tcp', 'proto': 'tcp' }
          - { 'dport': '443', 'match': 'udp', 'proto': 'udp' }

    - name: "Append rule ..."
      set_fact:
        fwrules: "{{ fwrules + fwrule_http }}"
        rule_parsed: true
  when: rule.allow == 'http'

- name: "Process allow/vpn ..."
  block:
    - name: "Append allow/vpn rules ..."
      set_fact:
        fwrule_vpn:
          - { 'iface': 'overlay0' }
          - { 'dport': '4242', 'match': 'udp', 'proto': 'udp' }
    - name: "Append rule ..."
      set_fact:
        fwrules: "{{ fwrules + fwrule_vpn }}"
        rule_parsed: true
  when: rule.allow == 'vpn'

- name: "Process allow/ssh ..."
  block:
    - name: "Extract config name ..."
      set_fact:
        ssh_firewall_file: "{{ rule.allow | split('/') | last | lower }}"

    - name: "Load ssh hosts ..."
      include_vars:
        file: "local/firewall/ssh/{{ ssh_firewall_file }}"
        name: ssh_firewall_hosts

    - name: "ERROR ..."
      fail:
      when: ssh_firewall_hosts.hosts is not defined

    - name: "Append rule ..."
      set_fact:
        fwrules: "{{ fwrules + [ { 'match': 'tcp', 'proto': 'tcp', 'src': ssh_firewall_hosts.hosts, 'dport': 22 } ] }}"
        rule_parsed: true
  when: rule.allow is regex('(?i)^ssh/[a-z][a-z0-9-]{1,18}[a-z0-9]$')
